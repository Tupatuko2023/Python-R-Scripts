name: r-ci

on:
  push:
    paths:
      - 'Fear-of-Falling/**/*.R'
      - 'Fear-of-Falling/**/*.r'
      - 'Fear-of-Falling/renv.lock'
      - 'Fear-of-Falling/renv/**'
      - '.github/workflows/r-ci.yml'
      - '!**/*.md'
  pull_request:
    paths:
      - 'Fear-of-Falling/**/*.R'
      - 'Fear-of-Falling/**/*.r'
      - 'Fear-of-Falling/renv.lock'
      - 'Fear-of-Falling/renv/**'
      - '.github/workflows/r-ci.yml'
      - '!**/*.md'

jobs:
  r-ci:
    runs-on: ubuntu-latest
    env:
      R_KEEP_PKG_SOURCE: yes
    steps:
      - uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Set up Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      # Compute primary R lib path (for caching)
      - name: Determine R library path
        id: rlib
        shell: Rscript {0}
        run: |
          cat(paste0("RLIB=", .libPaths()[1]), file = Sys.getenv("GITHUB_OUTPUT"))

      - name: Cache R packages (conditional)
        uses: actions/cache@v4
        with:
          path: ${{ steps.rlib.outputs.RLIB }}
          key: ${{ runner.os }}-r-${{ hashFiles('Fear-of-Falling/renv.lock') }}
          restore-keys: |
            ${{ runner.os }}-r-

      # Path A: Fear-of-Falling renv workflow (scripts repo)
      - name: Install renv (if missing)
        if: hashFiles('Fear-of-Falling/renv.lock') != ''
        run: Rscript -e "if (!requireNamespace('renv', quietly=TRUE)) install.packages('renv', repos='https://cloud.r-project.org')"

      - name: Restore renv (Fear-of-Falling)
        if: hashFiles('Fear-of-Falling/renv.lock') != ''
        run: Rscript -e "setwd('Fear-of-Falling'); renv::restore(prompt = FALSE)"

      - name: R env diagnostics (Fear-of-Falling)
        if: hashFiles('Fear-of-Falling/renv.lock') != ''
        run: Rscript -e "setwd('Fear-of-Falling'); print(sessionInfo()); renv::diagnostics()"

      # Otherwise, do a smoke test and finish successfully
      - name: Smoke tests
        if: hashFiles('Fear-of-Falling/renv.lock') == ''
        run: "Rscript -e \"print(sessionInfo()); message('Smoke tests completed')\""
