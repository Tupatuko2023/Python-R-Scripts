configfile: "config/config.yaml"

OUTPUT_DIR = config.get("output_dir", "outputs")
USE_SAMPLE = str(config.get("use_sample", "false")).lower() in ("1", "true", "yes", "y")

rule all:
    input:
        f"{OUTPUT_DIR}/reports/aim2_report.md"

rule inventory:
    output:
        f"{OUTPUT_DIR}/manifest/inventory.done"
    params:
        use_sample_flag = "--use-sample" if USE_SAMPLE else ""
    log:
        f"{OUTPUT_DIR}/logs/inventory.log"
    shell:
        "OUTPUT_DIR={OUTPUT_DIR} python workflow/scripts/inventory_wrapper.py {params.use_sample_flag} > {log} 2>&1"

rule preprocess:
    input:
        f"{OUTPUT_DIR}/manifest/inventory.done"
    output:
        f"{OUTPUT_DIR}/intermediate/analysis_ready.csv"
    params:
        use_sample_flag = "--use-sample" if USE_SAMPLE else "",
        allow_aggregates = "--allow-aggregates" if config.get("allow_aggregates") else "",
        allow_aggregates_env = "1" if config.get("allow_aggregates") else "0"
    log:
        f"{OUTPUT_DIR}/logs/preprocess.log"
    shell:
        "OUTPUT_DIR={OUTPUT_DIR} ALLOW_AGGREGATES={params.allow_aggregates_env} python scripts/10_preprocess_tabular.py {params.use_sample_flag} {params.allow_aggregates} > {log} 2>&1"

rule qc:
    input:
        f"{OUTPUT_DIR}/intermediate/analysis_ready.csv"
    output:
        f"{OUTPUT_DIR}/qc/qc_overview.csv",
        f"{OUTPUT_DIR}/qc/qc_inputs.csv",
        f"{OUTPUT_DIR}/qc/qc_missingness.csv",
        f"{OUTPUT_DIR}/qc/qc_schema_drift.csv",
        f"{OUTPUT_DIR}/qc/qc_key_uniqueness.csv",
        f"{OUTPUT_DIR}/qc/qc_date_sanity.csv",
        f"{OUTPUT_DIR}/qc/qc_join_coverage.csv"
    log:
        f"{OUTPUT_DIR}/logs/qc.log"
    shell:
        "OUTPUT_DIR={OUTPUT_DIR} python scripts/30_qc_summary.py --input {input} > {log} 2>&1"

rule models:
    input:
        f"{OUTPUT_DIR}/intermediate/analysis_ready.csv"
    output:
        f"{OUTPUT_DIR}/panel_models_summary.csv"
    log:
        f"{OUTPUT_DIR}/logs/models.log"
    shell:
        "Rscript scripts/30_models_panel_nb_gamma.R {input} {output} > {log} 2>&1"

rule report:
    input:
        qc_overview = f"{OUTPUT_DIR}/qc/qc_overview.csv",
        models = f"{OUTPUT_DIR}/panel_models_summary.csv"
    output:
        f"{OUTPUT_DIR}/reports/aim2_report.md"
    log:
        f"{OUTPUT_DIR}/logs/report.log"
    shell:
        "OUTPUT_DIR={OUTPUT_DIR} python scripts/50_build_report.py --out {output} > {log} 2>&1"
